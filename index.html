<div>
    <h1>Scan QR code</h1>

    <p id="msg" style="color: red;"></p> <!-- Элемент для вывода сообщений -->
    <ul id="deviceList"></ul> <!-- Список устройств -->

    <video id="videoElement" autoplay playsinline muted style="width: 300px; height: 300px; background-color: cadetblue;"></video>
    
    <script>
        const setMsg = (msg) => {
            document.getElementById("msg").innerHTML = msg;
        };

        async function getDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                const deviceList = document.getElementById("deviceList");
                deviceList.innerHTML = ""; // Очистка списка перед добавлением элементов

                videoDevices.forEach((device, index) => {
                    const listItem = document.createElement("li");
                    listItem.textContent = `${index + 1}: ${device.label || `Камера ${index + 1}`}`;
                    listItem.onclick = () => initCamera(device.deviceId); // Установка камеры по клику
                    deviceList.appendChild(listItem);
                });

                if (videoDevices.length === 0) {
                    setMsg("Видеоустройства не найдены.");
                } else {
                    setMsg("Выберите камеру из списка.");
                }
            } catch (error) {
                setMsg("Ошибка при получении списка устройств: " + error.message);
            }
        }

        async function initCamera(deviceId) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } }, audio: false });
                const video = document.getElementById("videoElement");

                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    video.play();
                    setMsg("Video is playing from selected camera.");
                };

                video.onplay = () => {
                    setMsg("Video is playing.");
                };

                video.onpause = () => {
                    setMsg("Video is paused.");
                };

                video.onerror = (e) => {
                    setMsg("Video error: " + e.message);
                };
            } catch (error) {
                setMsg("Ошибка при доступе к камере: " + error.message);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            getDevices(); // Получение и вывод списка устройств при загрузке страницы
            setMsg("Fetching available devices...");
        });
    </script>
</div>
